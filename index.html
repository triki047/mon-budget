<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Budget Pro</title>
    
    <!-- Optimisations Mobile Android & iOS -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        
        button, input, select { min-height: 44px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="p-3 md:p-8 relative pb-28 select-none">

    <!-- Modal Editeur de Catégories & Salaire -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-sliders-h mr-2 text-blue-600"></i>Paramètres</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 hide-scrollbar" id="categories-editor-list">
                <!-- Liste générée par JS -->
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
                <button onclick="addNewCategoryRow()" class="w-full mb-3 py-3 border-2 border-dashed border-blue-200 text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition">
                    <i class="fas fa-plus mr-1"></i> Créer un nouveau poste
                </button>
                <button onclick="saveSettings()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">
                    Enregistrer Tout
                </button>
            </div>
        </div>
    </div>

    <!-- Header Mobile -->
    <div class="max-w-6xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-gray-200 relative mt-2">
        <button onclick="toggleFullScreen()" class="absolute top-3 right-3 text-gray-400 hover:text-blue-600 p-2" title="Plein Écran"><i class="fas fa-expand fa-lg"></i></button>

        <div class="w-full">
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3"><i class="fas fa-wallet"></i></span>
                Mon Budget
            </h1>
            <p class="text-gray-400 text-xs mt-1 ml-1">Salaire de base : <span class="font-bold text-gray-800" id="salary-display">...</span></p>
        </div>
        <div class="mt-4 md:mt-0 w-full md:w-auto bg-green-50 p-3 rounded-xl border border-green-100 flex justify-between md:block items-center">
            <p class="text-xs text-green-600 uppercase font-semibold">Solde Disponible</p>
            <p id="global-remaining" class="text-2xl font-bold text-green-700">0 FCFA</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Colonne Gauche -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Tableau de Bord -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-5 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700 text-sm uppercase tracking-wide">État des Postes</h2>
                    <div class="flex space-x-2">
                        <button onclick="openSettings()" class="text-xs bg-indigo-50 border border-indigo-200 text-indigo-700 px-3 py-1.5 rounded-full font-bold shadow-sm active:bg-indigo-100 flex items-center">
                            <i class="fas fa-cog mr-1"></i> Réglages Budget
                        </button>
                    </div>
                </div>
                <div class="p-0 overflow-x-auto hide-scrollbar">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-white text-gray-400 text-xs uppercase font-semibold border-b">
                            <tr>
                                <th class="px-5 py-3">Poste</th>
                                <th class="px-5 py-3 text-right">Reste</th>
                                <th class="px-5 py-3 text-center">État</th>
                            </tr>
                        </thead>
                        <tbody id="budget-table-body" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ajout Transaction (Entrée / Sortie) -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5">
                <h2 class="font-bold text-gray-700 mb-4 flex items-center justify-between">
                    <span><i class="fas fa-exchange-alt text-blue-500 mr-2"></i>Nouvelle Opération</span>
                </h2>
                
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Switch Type -->
                    <div class="md:col-span-4 flex rounded-xl bg-gray-100 p-1 mb-2">
                        <button type="button" id="btn-type-expense" onclick="setTransactionType('expense')" class="flex-1 py-2 rounded-lg font-bold text-sm shadow-sm bg-white text-red-600 transition">
                            <i class="fas fa-minus-circle mr-1"></i> Dépense (Sortie)
                        </button>
                        <button type="button" id="btn-type-income" onclick="setTransactionType('income')" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:text-green-600 transition">
                            <i class="fas fa-plus-circle mr-1"></i> Revenu (Entrée)
                        </button>
                    </div>
                    <input type="hidden" id="trans-type" value="expense">

                    <div class="grid grid-cols-2 gap-4 md:col-span-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Date</label>
                            <input type="date" id="date" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-gray-700">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Montant</label>
                            <div class="relative">
                                <input type="number" id="amount" inputmode="numeric" pattern="[0-9]*" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-4 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800 text-lg" required>
                                <span class="absolute right-4 top-3.5 text-gray-400 text-sm font-bold">F</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-4" id="category-section">
                        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Concerne quel poste ?</label>
                        <div class="grid grid-cols-3 gap-2" id="category-buttons">
                             <!-- Boutons générés par JS -->
                        </div>
                        <input type="hidden" id="category">
                    </div>

                    <!-- Champ description pour Revenu (affiché seulement si Revenu) -->
                    <div class="md:col-span-4 hidden" id="income-desc-section">
                        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Source du revenu</label>
                        <input type="text" id="income-desc" placeholder="Ex: Bonus, Cadeau, Remboursement..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none font-semibold text-gray-700">
                    </div>

                    <div class="md:col-span-4 mt-2">
                        <button type="submit" id="submit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 transition transform active:scale-95 text-lg">
                            Enregistrer la Dépense
                        </button>
                    </div>
                </form>
            </div>

             <!-- Journal & Sauvegardes -->
             <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-20 md:mb-0">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
                    <h2 class="font-bold text-gray-700">Historique & Données</h2>
                    
                    <!-- Boutons de Sauvegarde -->
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="exportJSON()" class="flex-1 md:flex-none text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold border border-blue-100 flex items-center justify-center shadow-sm active:scale-95 transition">
                           <i class="fas fa-save mr-1"></i> Sauver
                        </button>
                        <label for="import-file" class="flex-1 md:flex-none text-xs bg-gray-50 text-gray-600 px-3 py-2 rounded-lg font-bold border border-gray-200 cursor-pointer flex items-center justify-center shadow-sm active:scale-95 transition">
                           <i class="fas fa-upload mr-1"></i> Restaurer
                        </label>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(this)">
                        
                        <button onclick="exportToCSV()" class="flex-1 md:flex-none text-xs bg-green-50 text-green-600 px-3 py-2 rounded-lg font-bold border border-green-100 flex items-center justify-center shadow-sm active:scale-95 transition">
                           <i class="fas fa-file-excel mr-1"></i> Excel
                        </button>
                   </div>
                </div>
                
                <ul id="expense-list" class="space-y-3 max-h-80 overflow-y-auto pr-1 hide-scrollbar">
                    <!-- Liste -->
                </ul>
                <div class="mt-4 text-center">
                    <button onclick="askResetMonth()" class="text-xs text-red-400 border border-red-100 px-3 py-1 rounded-full hover:bg-red-50 transition">Réinitialiser tout le mois</button>
                </div>
            </div>
        </div>

        <!-- Colonne Droite -->
        <div class="lg:col-span-1 space-y-6 hidden lg:block">
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl shadow-xl p-6 text-white">
                <h2 class="font-bold text-lg mb-4"><i class="fas fa-rocket mr-2 text-yellow-300"></i>Mon Rêve</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-indigo-200 uppercase font-bold">Prix (FCFA)</label>
                        <input type="number" id="project-cost" value="200000" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 text-white font-bold text-lg focus:bg-white/20 outline-none" oninput="calculateProject()">
                    </div>
                    <div class="pt-4 border-t border-white/10 flex justify-between items-end">
                        <div>
                            <p class="text-xs text-indigo-200">Durée estimée</p>
                            <p id="project-duration" class="text-4xl font-bold text-yellow-300">10</p>
                        </div>
                        <span class="text-sm mb-2 text-indigo-200 font-medium">Mois</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // Configuration initiale par défaut
        const defaultBudgetPlan = [
            { id: 'cat_1', name: 'Banque', limit: 10332, type: 'fixed' },
            { id: 'cat_2', name: 'Maman', limit: 50000, type: 'fixed' },
            { id: 'cat_3', name: 'Internet', limit: 3000, type: 'fixed' },
            { id: 'cat_4', name: 'Transport', limit: 9000, type: 'variable' },
            { id: 'cat_5', name: 'Projet', limit: 20000, type: 'variable' },
            { id: 'cat_6', name: 'Imprévus', limit: 5000, type: 'variable' },
            { id: 'cat_7', name: 'Petite Amie', limit: 10000, type: 'variable' },
            { id: 'cat_8', name: 'Envies', limit: 10000, type: 'variable' },
            { id: 'cat_9', name: 'Divers', limit: 6632, type: 'variable' }
        ];

        // Chargement des données
        let salary = parseInt(localStorage.getItem('salary')) || 123964;
        let budgetPlan = JSON.parse(localStorage.getItem('budgetPlan')) || JSON.parse(JSON.stringify(defaultBudgetPlan));
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        
        document.getElementById('date').valueAsDate = new Date();

        // --- GESTION DU TYPE (Dépense vs Revenu) ---
        function setTransactionType(type) {
            const btnExpense = document.getElementById('btn-type-expense');
            const btnIncome = document.getElementById('btn-type-income');
            const submitBtn = document.getElementById('submit-btn');
            const catSection = document.getElementById('category-section');
            const incDescSection = document.getElementById('income-desc-section');
            const inputType = document.getElementById('trans-type');

            inputType.value = type;

            if (type === 'expense') {
                btnExpense.className = "flex-1 py-2 rounded-lg font-bold text-sm shadow-sm bg-white text-red-600 transition";
                btnIncome.className = "flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:text-green-600 transition";
                submitBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 transition transform active:scale-95 text-lg";
                submitBtn.innerText = "Enregistrer la Dépense (-)";
                catSection.classList.remove('hidden');
                incDescSection.classList.add('hidden');
                document.getElementById('category').required = true;
                document.getElementById('income-desc').required = false;
            } else {
                btnExpense.className = "flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:text-red-600 transition";
                btnIncome.className = "flex-1 py-2 rounded-lg font-bold text-sm shadow-sm bg-white text-green-600 transition";
                submitBtn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-95 text-lg";
                submitBtn.innerText = "Enregistrer le Revenu (+)";
                catSection.classList.add('hidden');
                incDescSection.classList.remove('hidden');
                document.getElementById('category').required = false;
                document.getElementById('income-desc').required = true;
            }
        }

        // --- AFFICHAGE CATEGORIES BOUTONS ---
        function renderCategoryButtons() {
            const container = document.getElementById('category-buttons');
            container.innerHTML = '';
            budgetPlan.forEach(cat => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'cat-btn bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-semibold text-gray-600 hover:bg-blue-50 truncate transition';
                btn.innerText = cat.name;
                btn.dataset.id = cat.id; 
                btn.onclick = () => selectCategory(btn, cat.id);
                container.appendChild(btn);
            });
        }

        function selectCategory(btn, catId) {
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = 'cat-btn bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-semibold text-gray-600 hover:bg-blue-50 truncate transition';
            });
            if(!btn) {
                btn = document.querySelector(`.cat-btn[data-id="${catId}"]`);
            }
            if(btn) {
                btn.className = 'cat-btn bg-blue-600 text-white border-blue-600 rounded-lg p-2 text-xs font-semibold truncate transition shadow-md';
            }
            document.getElementById('category').value = catId;
        }

        // --- DASHBOARD CORE ---
        function updateDashboard() {
            const tbody = document.getElementById('budget-table-body');
            tbody.innerHTML = '';
            
            // Mise à jour Affichage Salaire
            document.getElementById('salary-display').innerText = salary.toLocaleString() + ' F';

            let totalExpenses = 0;
            let totalIncomeExtra = 0;

            transactions.filter(t => t.type === 'income').forEach(t => {
                totalIncomeExtra += t.amount;
            });

            budgetPlan.forEach(cat => {
                const spent = transactions
                    .filter(t => t.type === 'expense' && t.categoryId === cat.id)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                totalExpenses += spent;
                const remaining = cat.limit - spent;
                const percent = Math.min((spent / cat.limit) * 100, 100);
                
                let barColor = remaining < 0 ? 'bg-red-500' : (remaining < cat.limit * 0.2 ? 'bg-yellow-500' : 'bg-blue-500');
                let statusIcon = remaining < 0 ? '<i class="fas fa-exclamation-circle text-red-500"></i>' : '<i class="fas fa-check-circle text-green-500"></i>';
                let remainingColor = remaining < 0 ? 'text-red-600' : 'text-gray-700';

                tbody.innerHTML += `
                    <tr class="border-b border-gray-50 last:border-0">
                        <td class="px-5 py-4">
                            <div class="font-bold text-gray-800 text-sm">${cat.name}</div>
                            <div class="text-[10px] text-gray-400">Budget: ${cat.limit.toLocaleString()}</div>
                            <div class="w-24 bg-gray-100 rounded-full h-1.5 mt-1 overflow-hidden"><div class="${barColor} h-1.5 rounded-full" style="width: ${percent}%"></div></div>
                        </td>
                        <td class="px-5 py-4 text-right font-mono font-bold ${remainingColor} text-sm">${remaining.toLocaleString()}</td>
                        <td class="px-5 py-4 text-center text-lg">${statusIcon}</td>
                    </tr>`;
            });

            const totalAvailable = salary + totalIncomeExtra - totalExpenses;
            const globalEl = document.getElementById('global-remaining');
            globalEl.innerText = totalAvailable.toLocaleString() + ' F';
            globalEl.className = totalAvailable < 0 ? 'text-2xl font-bold text-red-600' : 'text-2xl font-bold text-green-700';

            renderHistory();
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('budgetPlan', JSON.stringify(budgetPlan));
            localStorage.setItem('salary', salary);
        }

        function renderHistory() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            const recent = [...transactions].reverse().slice(0, 15);
            
            if(recent.length === 0) {
                list.innerHTML = '<li class="text-gray-400 text-sm italic text-center py-6">Aucune opération.</li>';
                return;
            }

            recent.forEach((t, index) => {
                const originalIndex = transactions.length - 1 - index;
                
                let icon, colorClass, sign, label;
                if(t.type === 'income') {
                    icon = 'fa-arrow-down';
                    colorClass = 'text-green-600 bg-green-50';
                    sign = '+';
                    label = t.description || 'Revenu';
                } else {
                    icon = 'fa-arrow-up';
                    colorClass = 'text-red-500 bg-red-50';
                    sign = '-';
                    const cat = budgetPlan.find(c => c.id === t.categoryId);
                    label = cat ? cat.name : 'Inconnu';
                }

                list.innerHTML += `
                    <li class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center mr-3">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div>
                                <span class="text-xs text-gray-400 block font-medium uppercase tracking-wide">${new Date(t.date).toLocaleDateString()}</span>
                                <span class="font-bold text-gray-800 text-sm">${label}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold font-mono ${t.type === 'income' ? 'text-green-600' : 'text-gray-800'} text-sm md:text-base mr-2">${sign} ${t.amount.toLocaleString()}</span>
                            <button onclick="editTransaction(${originalIndex})" class="w-8 h-8 rounded-full bg-blue-50 text-blue-400 hover:text-blue-600 hover:bg-blue-100 flex items-center justify-center transition">
                                <i class="fas fa-pencil-alt text-xs"></i>
                            </button>
                            <button onclick="deleteTransaction(${originalIndex})" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </li>`;
            });
        }

        document.getElementById('transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const type = document.getElementById('trans-type').value;
            const amount = parseInt(document.getElementById('amount').value);
            const date = document.getElementById('date').value;

            if(!amount || !date) return;

            const newTrans = {
                type: type,
                amount: amount,
                date: date,
                id: Date.now()
            };

            if(type === 'expense') {
                const catId = document.getElementById('category').value;
                if(!catId) { alert("Choisis un poste !"); return; }
                newTrans.categoryId = catId;
            } else {
                newTrans.description = document.getElementById('income-desc').value || "Revenu";
            }

            transactions.push(newTrans);
            updateDashboard();
            
            document.getElementById('amount').value = '';
            if(type === 'income') document.getElementById('income-desc').value = '';
            const btn = document.getElementById('submit-btn');
            const oldText = btn.innerText;
            btn.innerText = "Enregistré !";
            setTimeout(() => {
                if(document.getElementById('trans-type').value === 'expense') {
                    btn.innerText = "Enregistrer la Dépense (-)";
                } else {
                    btn.innerText = "Enregistrer le Revenu (+)";
                }
            }, 1000);
        });

        function editTransaction(index) {
            if(confirm("Modifier cette opération ? Elle remontera dans le formulaire pour correction.")) {
                const t = transactions[index];
                setTransactionType(t.type);
                document.getElementById('date').value = t.date;
                document.getElementById('amount').value = t.amount;
                if(t.type === 'expense') {
                    selectCategory(null, t.categoryId);
                } else {
                    document.getElementById('income-desc').value = t.description;
                }
                transactions.splice(index, 1);
                updateDashboard();
                document.getElementById('transaction-form').scrollIntoView({behavior: 'smooth'});
            }
        }

        function deleteTransaction(index) {
            if(confirm("Supprimer cette opération ?")) {
                transactions.splice(index, 1);
                updateDashboard();
            }
        }

        function askResetMonth() {
            if(confirm("Tout effacer pour repartir à zéro ce mois-ci ?")) {
                transactions = [];
                updateDashboard();
            }
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Date,Type,Poste/Description,Montant\n";
            transactions.forEach(t => {
                let label = t.description || (budgetPlan.find(c => c.id === t.categoryId)?.name || 'Inconnu');
                let typeStr = t.type === 'income' ? 'Revenu' : 'Dépense';
                csvContent += `${t.date},${typeStr},${label},${t.amount}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "mon_budget_excel.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportJSON() {
            const data = {
                transactions: transactions,
                budgetPlan: budgetPlan,
                salary: salary // Sauvegarder le salaire aussi
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = "sauvegarde_budget_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importJSON(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.transactions && data.budgetPlan) {
                        if(confirm("Cela va remplacer toutes les données actuelles. Continuer ?")) {
                            transactions = data.transactions;
                            budgetPlan = data.budgetPlan;
                            salary = data.salary || 123964; // Charger le salaire
                            updateDashboard();
                            renderCategoryButtons();
                            alert("Données restaurées avec succès !");
                        }
                    } else { alert("Format invalide (Ancienne version ?)"); }
                } catch (err) { alert("Erreur de lecture du fichier"); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- SETTINGS (Modifier Postes & Salaire) ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsList();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function renderSettingsList() {
            const container = document.getElementById('categories-editor-list');
            container.innerHTML = '';
            
            // 1. AJOUT : INPUT POUR LE SALAIRE
            container.innerHTML += `
                <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                    <label class="text-xs uppercase text-blue-500 font-bold mb-1 block">Mon Salaire / Revenu Fixe</label>
                    <div class="relative">
                        <input type="number" value="${salary}" id="edit-salary" class="w-full p-3 rounded-lg border border-blue-200 text-lg font-bold text-blue-800 focus:ring-2 focus:ring-blue-500 outline-none">
                        <span class="absolute right-4 top-3.5 text-blue-300 font-bold">FCFA</span>
                    </div>
                    <p class="text-[10px] text-blue-400 mt-2">Ce montant sert de base pour calculer ton "Reste à vivre".</p>
                </div>
                <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase border-b pb-2">Mes Postes de Dépense</h4>
            `;

            // 2. LISTE DES CATÉGORIES
            budgetPlan.forEach((cat, idx) => {
                container.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                        <div class="flex gap-2 mb-2">
                            <div class="flex-1">
                                <label class="text-[10px] uppercase text-gray-400 font-bold">Nom du poste</label>
                                <input type="text" value="${cat.name}" id="edit-name-${idx}" class="w-full p-2 rounded border border-gray-200 text-sm font-bold text-gray-700 focus:border-blue-500 outline-none">
                            </div>
                            <div class="w-1/3">
                                <label class="text-[10px] uppercase text-gray-400 font-bold">Budget</label>
                                <input type="number" value="${cat.limit}" id="edit-limit-${idx}" class="w-full p-2 rounded border border-gray-200 text-sm font-bold text-gray-700 focus:border-blue-500 outline-none">
                            </div>
                        </div>
                        <button onclick="removeCategory(${idx})" class="text-xs text-red-400 hover:text-red-600 flex items-center"><i class="fas fa-trash mr-1"></i> Supprimer ce poste</button>
                    </div>`;
            });
        }

        function addNewCategoryRow() {
            const newId = 'cat_' + Date.now();
            budgetPlan.push({ id: newId, name: 'Nouveau Poste', limit: 0, type: 'variable' });
            renderSettingsList();
            const container = document.getElementById('categories-editor-list');
            container.scrollTop = container.scrollHeight;
        }

        function removeCategory(index) {
            if(confirm("Supprimer définitivement ce poste ?")) {
                budgetPlan.splice(index, 1);
                renderSettingsList();
            }
        }

        function saveSettings() {
            // Sauvegarder le Salaire
            const salaryInput = document.getElementById('edit-salary');
            if(salaryInput) {
                salary = parseInt(salaryInput.value) || 0;
            }

            // Sauvegarder les catégories
            budgetPlan.forEach((cat, idx) => {
                const nameInput = document.getElementById(`edit-name-${idx}`);
                const limitInput = document.getElementById(`edit-limit-${idx}`);
                if(nameInput) cat.name = nameInput.value;
                if(limitInput) cat.limit = parseInt(limitInput.value) || 0;
            });
            
            localStorage.setItem('salary', salary);
            localStorage.setItem('budgetPlan', JSON.stringify(budgetPlan));
            updateDashboard();
            renderCategoryButtons();
            closeSettings();
        }

        function calculateProject() {
            const cost = parseInt(document.getElementById('project-cost').value) || 0;
            const projCat = budgetPlan.find(c => c.name.toLowerCase().includes('projet'));
            const saving = projCat ? projCat.limit : 20000;
            
            if (cost > 0 && saving > 0) {
                document.getElementById('project-duration').innerText = (cost / saving).toFixed(1);
            } else {
                document.getElementById('project-duration').innerText = "—";
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => console.log(e)); }
            else if (document.exitFullscreen) { document.exitFullscreen(); }
        }

        renderCategoryButtons();
        updateDashboard();

    </script>
</body>
</html>
